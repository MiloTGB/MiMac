#!/usr/bin/env bash
set -euo pipefail

# MiMac installer — unified macOS bootstrap
#
# Usage:
#   scripts/install              # Phase 1 only (setup: dotfiles, tools, defaults)
#   scripts/install --brew       # Phase 2 (Homebrew packages)
#   scripts/install --post       # Phase 3 (app config, login items)
#   scripts/install --all        # All phases sequentially
#
# All other flags are passed through to the relevant phase script.

SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
  DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"

# Source shared helpers
# shellcheck source=lib.sh
source "$SCRIPT_DIR/lib.sh"

check_macos

# Parse top-level flag
PHASE=""
PASSTHROUGH=()

for arg in "$@"; do
  case "$arg" in
    --brew)  PHASE="brew" ;;
    --post)  PHASE="post" ;;
    --all)   PHASE="all" ;;
    -h|--help)
      cat <<'USAGE'
MiMac installer — unified macOS bootstrap

Usage: scripts/install [phase] [options]

Phases:
  (default)     Phase 1: setup (dotfiles, tools, defaults, shell)
  --brew        Phase 2: Homebrew packages
  --post        Phase 3: app config, login items
  --all         All phases sequentially

All other flags are passed through to the relevant phase script.
Run scripts/setup --help or scripts/brew-packages --help for phase-specific options.
USAGE
      exit 0
      ;;
    *)  PASSTHROUGH+=("$arg") ;;
  esac
done

case "${PHASE:-setup}" in
  setup)
    exec "$SCRIPT_DIR/setup" "${PASSTHROUGH[@]+"${PASSTHROUGH[@]}"}"
    ;;
  brew)
    exec "$SCRIPT_DIR/brew-packages" "${PASSTHROUGH[@]+"${PASSTHROUGH[@]}"}"
    ;;
  post)
    exec "$SCRIPT_DIR/post-install" "${PASSTHROUGH[@]+"${PASSTHROUGH[@]}"}"
    ;;
  all)
    log "Running all phases..."
    "$SCRIPT_DIR/setup" "${PASSTHROUGH[@]+"${PASSTHROUGH[@]}"}"
    "$SCRIPT_DIR/brew-packages" "${PASSTHROUGH[@]+"${PASSTHROUGH[@]}"}"
    "$SCRIPT_DIR/post-install" "${PASSTHROUGH[@]+"${PASSTHROUGH[@]}"}"
    log "All phases complete."
    ;;
esac
