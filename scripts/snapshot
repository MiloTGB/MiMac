#!/usr/bin/env bash
set -euo pipefail

# MiMac snapshot — capture current machine state into the project
#
# Run before migrating to a new machine to ensure the project
# reflects your current setup. Commits changes if any.
#
# Usage: make snapshot

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

log(){ printf "[snapshot] %s\n" "$*"; }
changed=0

###############################################################################
# Brewfile                                                                    #
###############################################################################

log "Dumping Brewfile from installed packages..."
brew bundle dump --force --file="$REPO_ROOT/Brewfile" 2>/dev/null

# Restore section comments by grouping
TMPFILE=$(mktemp)
{
  echo "# CLI Tools"
  grep '^brew ' "$REPO_ROOT/Brewfile" | sort
  echo ""
  echo "# Applications"
  grep '^cask ' "$REPO_ROOT/Brewfile" | sort
  echo ""
  # Preserve taps if any
  if grep -q '^tap ' "$REPO_ROOT/Brewfile"; then
    echo "# Taps"
    grep '^tap ' "$REPO_ROOT/Brewfile" | sort
  fi
} > "$TMPFILE"
mv "$TMPFILE" "$REPO_ROOT/Brewfile"
log "Brewfile updated"
((changed++))

###############################################################################
# Dock layout                                                                 #
###############################################################################

log "Capturing Dock layout..."
DOCK_APPS=()
while IFS= read -r label; do
  [[ -n "$label" ]] && DOCK_APPS+=("$label")
done < <(defaults export com.apple.dock - | grep -A1 'file-label' | grep '<string>' | /usr/bin/sed 's/.*<string>//; s/<\/string>//')

# Update dock-setup script with current apps
DOCK_SCRIPT="$REPO_ROOT/scripts/dock-setup"
if [[ -f "$DOCK_SCRIPT" ]]; then
  # Build the new DOCK_APPS array
  NEW_APPS=""
  for label in "${DOCK_APPS[@]}"; do
    # Resolve app path
    app_path=""
    if [[ -d "/Applications/$label.app" ]]; then
      app_path="/Applications/$label.app"
    elif [[ -d "/System/Applications/$label.app" ]]; then
      app_path="/System/Applications/$label.app"
    elif [[ -d "/System/Applications/Utilities/$label.app" ]]; then
      app_path="/System/Applications/Utilities/$label.app"
    fi
    if [[ -n "$app_path" ]]; then
      NEW_APPS+="  \"$app_path\"\n"
    else
      log "Warning: could not find app path for '$label'"
    fi
  done

  # Replace the DOCK_APPS array in the script
  /usr/bin/sed -i '' '/^DOCK_APPS=(/,/^)/c\
DOCK_APPS=(\
'"$(/usr/bin/sed 's/$/\\/' <<< "$NEW_APPS" | /usr/bin/sed '$ s/\\$//')"'
)' "$DOCK_SCRIPT" 2>/dev/null || log "Warning: could not update dock-setup automatically"
  
  log "Dock layout captured (${#DOCK_APPS[@]} apps)"
  ((changed++))
fi

###############################################################################
# App preferences                                                             #
###############################################################################

PREFS_DIR="$REPO_ROOT/assets/preferences"

# iTerm2
if [[ -f "$HOME/Library/Preferences/com.googlecode.iterm2.plist" ]]; then
  defaults export com.googlecode.iterm2 "$PREFS_DIR/iTerm2.plist"
  log "Exported iTerm2 preferences"
  ((changed++))
fi

# Audio Hijack — capture current settings
if [[ -d "/Applications/Audio Hijack.app" ]]; then
  theme=$(defaults read com.rogueamoeba.AudioHijack applicationTheme 2>/dev/null || echo "")
  buffer=$(defaults read com.rogueamoeba.AudioHijack bufferFrames 2>/dev/null || echo "")
  if [[ -n "$theme" || -n "$buffer" ]]; then
    log "Audio Hijack preferences unchanged (managed by defaults script)"
  fi
fi

###############################################################################
# Summary                                                                     #
###############################################################################

cd "$REPO_ROOT"
if git diff --quiet && git diff --cached --quiet; then
  log "No changes detected. Project already matches machine state."
else
  log "Changes detected. Review and commit:"
  git status --short
  echo ""
  read -r -p "[snapshot] Commit changes? [y/N] " answer
  if [[ "$answer" =~ ^[Yy]$ ]]; then
    git add -A
    git commit -m "snapshot: update project to match current machine state"
    log "Committed. Run 'git push' when ready."
  else
    log "Changes staged but not committed."
  fi
fi
